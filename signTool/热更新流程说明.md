# 热更新流程说明

## 🎯 概述
本文档说明如何修改热更新服务器地址并正确构建和部署热更新文件。

## 🔄 第一次设置流程

### 1. 修改热更新配置
```bash
# 修改热更新服务器地址
./signTool/change_update_dir.sh ldupdate
```

### 2. Cocos Creator 构建
```bash
# 在 Cocos Creator 中构建项目
# 生成 build/jsb-link/ 目录和所有游戏资源
```

### 3. 生成热更新文件
```bash
# 基于构建结果生成新的热更新文件
node version_generator.js
# 这会生成新的 project.manifest 和 version.manifest 文件
```

### 4. 替换清单文件
```bash
# 将生成的 project.manifest 复制到 assets/ 目录
cp project.manifest assets/project.manifest
```

### 5. 重新构建（用于打包）
```bash
# 在 Cocos Creator 中重新构建项目
# 确保 APK/IPA 中包含最新的热更新配置
```

### 6. 上传到服务器
```bash
# 将生成的热更新文件上传到服务器
# 包括：project.manifest, version.manifest 和 assets/ 目录
```

## 🔄 后续热更新流程

### 1. 修改代码
```bash
# 在 Cocos Creator 中修改游戏代码
```

### 2. 构建
```bash
# 在 Cocos Creator 中构建项目
```

### 3. 生成热更新文件
```bash
# 基于构建结果生成新的热更新文件
node version_generator.js
```

### 4. 上传到服务器
```bash
# 将生成的热更新文件上传到服务器
# 包括：project.manifest, version.manifest 和 assets/ 目录
```

## 🎯 关键点说明

### 第一次设置为什么需要重新构建？
1. **`assets/project.manifest` 会被打包到APK/IPA中**
   - 这个文件在构建时会被包含在最终的安装包中
   - 游戏启动时会读取这个文件来获取热更新地址

2. **确保安装包包含最新的配置**
   - 重新构建后，APK/IPA中的 `assets/project.manifest` 是最新的
   - 包含正确的服务器地址和版本信息

### 后续热更新为什么不需要重新构建？
1. **`assets/project.manifest` 已经设置好了**
   - 游戏已经知道从哪里下载热更新
   - 不需要重新编译游戏

2. **热更新机制**
   - 游戏启动时读取本地的 `assets/project.manifest`
   - 根据其中的 `remoteVersionUrl` 检查服务器上的版本
   - 如果服务器版本更新，就下载新的资源

## 📁 服务器端目录结构

```
服务器根目录/
├── ldupdate/                    # 热更新目录
│   ├── project.manifest
│   ├── version.manifest
│   └── assets/
└── ldconfig/                    # 配置目录
    └── release_first.json
```

## ⚠️ 注意事项

1. **备份重要**：修改前务必备份原始文件
2. **服务器同步**：确保服务器端也创建对应的目录
3. **测试验证**：修改后测试热更新功能是否正常
4. **配置文件**：注意配置目录也要相应修改
5. **版本管理**：执行 version_generator.js 后手动替换 project.manifest
6. **文件替换**：生成后需要手动替换 assets/project.manifest 文件

## 🔄 还原方法

如果需要还原到原始状态：
```bash
# 从备份恢复
cp backup_*/version_generator.js ./
cp backup_*/assets/project.manifest ./
# ... 恢复其他文件
```

## 📋 总结

- **第一次设置**：修改配置 → 构建 → 生成热更新文件 → 替换清单 → 重新构建 → 上传
- **后续热更新**：修改代码 → 构建 → 生成热更新文件 → 上传
- **关键区别**：第一次需要重新构建以确保安装包包含最新的热更新配置
